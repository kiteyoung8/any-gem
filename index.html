/* åƒ…æ›¿æ› script ä¸­çš„ handleSend å‡½å¼å€å¡Š */
async function handleSend() {
    const text = input.value.trim();
    if(!text && !activeFile.base64) return;
    
    addMessage('user', text);
    input.value = ''; zenInput.value = '';
    
    const currentMode = modeSelect.value;
    setLoading(true, currentMode === 'art' ? "Creating Art..." : "AI Thinking...");
    
    let extra = null;
    if(currentMode === 'presentation') {
        extra = { 
            strategy: document.getElementById('ppt-strategy').value, 
            theme: document.getElementById('ppt-theme').value, 
            customStyle: document.getElementById('ppt-custom-style').value 
        };
    }

    try {
        const res = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                message: text, 
                mode: currentMode, 
                history: chatHistory.slice(-6), 
                imageBase64: activeFile.base64, 
                mimeType: activeFile.mime, 
                options: extra 
            }) 
        });
        
        const data = await res.json();
        activeFile = { base64: null, mime: null };
        
        if(data.status === "success") {
            // âœ¨ é—œéµä¿®æ­£ï¼šç¢ºå¯¦åˆ¤å®šå¾Œç«¯å‚³å›çš„æ˜¯åœ–ç‰‡é‚„æ˜¯æ–‡å­—
            if(data.type === 'art' || data.image) {
                renderArtCard(data.image, data.reply || text);
            } else {
                addMessage('ai', data.reply, { docUrl: data.docUrl, model: data.model });
                // å­˜å…¥å°è©±è¨˜æ†¶
                chatHistory.push({ role: 'user', content: text });
                chatHistory.push({ role: 'model', content: data.reply });
                if(chatHistory.length > 6) chatHistory = chatHistory.slice(-6);
            }
        } else {
            addMessage('ai', "ğŸš¨ ç³»çµ±è¨Šæ¯: " + data.error);
        }
    } catch (e) { 
        addMessage('ai', "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); 
    } finally { 
        setLoading(false); 
    }
}
