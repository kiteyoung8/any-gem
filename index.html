/* æ›¿æ› script ä¸­çš„ handleSend å‡½å¼ */
async function handleSend() {
    const text = input.value.trim();
    if(!text && !activeFile.base64) return;
    
    addMessage('user', text);
    input.value = ''; zenInput.value = '';
    
    const m = modeSelect.value;
    setLoading(true, m === 'art' ? "Creating Art..." : "Thinking...");

    try {
        const res = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                message: text, 
                mode: m, 
                history: chatHistory.slice(-6), 
                imageBase64: activeFile.base64, 
                mimeType: activeFile.mime, 
                options: m === 'presentation' ? { strategy: document.getElementById('ppt-strategy').value, theme: document.getElementById('ppt-theme').value, customStyle: document.getElementById('ppt-custom-style').value } : null 
            }) 
        });
        
        const data = await res.json();
        console.log("Backend Response:", data); // âœ¨ é–‹å•Ÿ F12 å³å¯çœ‹åˆ°èª¿è©¦è³‡è¨Š
        
        activeFile = { base64: null, mime: null };

        if(data.status === "success") {
            // âœ¨ åˆ¤å®šç”Ÿåœ–é¡å‹
            if(data.type === 'art' || data.image) {
                renderArtCard(data.image, data.reply || text);
            } else {
                addMessage('ai', data.reply, { docUrl: data.docUrl });
                chatHistory.push({ role: 'user', content: text }, { role: 'model', content: data.reply });
            }
        } else {
            addMessage('ai', "ğŸš¨ éŒ¯èª¤è©³æƒ…: " + data.error);
        }
    } catch (e) {
        console.error("Fetch Error:", e);
        addMessage('ai', "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯éƒ¨ç½²ç¶²å€ã€‚");
    } finally {
        setLoading(false);
    }
}
