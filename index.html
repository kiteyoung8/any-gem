<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šåŠ å…¥ maximum-scale=1.0 å’Œ user-scalable=noï¼Œé˜²æ­¢ iOS éµç›¤å½ˆå‡ºæ™‚å¼·åˆ¶æ”¾å¤§å°è‡´è·‘ç‰ˆ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>anyGem - Super Agent v72.1 (Mobile Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { background-color: #131314; color: #e3e3e3; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šå¼·åŒ– Markdown å…§æ–‡çš„æ›è¡Œè™•ç†ï¼Œé˜²æ­¢é•·ç¶²å€æŠŠæ‰‹æ©Ÿç•«é¢æ’ç ´ */
        .prose { max-width: 100%; word-break: break-word; overflow-wrap: break-word; }
        .prose pre { background-color: #1e1e20; border-radius: 12px; padding: 1.25rem; overflow-x: auto; border: 1px solid #333; margin: 1rem 0; position: relative; max-width: 100%; }
        .prose code { color: #f87171; background-color: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.9em; font-family: 'Fira Code', monospace; }
        .prose a { color: #8ab4f8; text-decoration: underline; text-underline-offset: 4px; transition: color 0.2s; }
        .prose h1, .prose h2, .prose h3 { color: #fff; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; }
        .prose img { max-width: 100%; border-radius: 0.75rem; height: auto; }

        .typing-indicator span { animation: blink 1.4s infinite both; height: 5px; width: 5px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .active-session { background-color: #33353a; color: white; border-left: 4px solid #8ab4f8; }
        .pinned-icon { transform: rotate(-45deg); color: #8ab4f8; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-md flex-col">
        <div class="h-14 bg-[#1e1f22] border-b border-[#333] flex items-center justify-between px-4 sm:px-6">
            <div class="flex items-center gap-2 sm:gap-3">
                <span class="material-symbols-rounded text-blue-400">deployed_code</span>
                <span class="font-semibold text-xs sm:text-sm tracking-wide text-white truncate">Artifact Preview</span>
            </div>
            <div class="flex items-center gap-2 sm:gap-4 shrink-0">
                <button onclick="refreshPreview()" class="p-2 text-gray-400 hover:text-white transition-colors"><span class="material-symbols-rounded">refresh</span></button>
                <button onclick="closePreview()" class="p-2 text-gray-400 hover:text-red-400 bg-[#333] hover:bg-red-500/10 rounded-full transition-all"><span class="material-symbols-rounded">close</span></button>
            </div>
        </div>
        <div class="flex-1 bg-white relative">
            <iframe id="preview-iframe" sandbox="allow-scripts allow-forms allow-modals" class="w-full h-full border-none absolute inset-0"></iframe>
        </div>
    </div>

    <aside id="sidebar" class="w-72 bg-[#1e1f22] border-r border-[#333] flex flex-col transition-all duration-300 z-30 absolute md:relative h-full -translate-x-full md:translate-x-0">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-xl">auto_awesome</span>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">anyGem Agent</h1>
            </div>
            <button onclick="startNewSession()" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-3 rounded-xl transition-all shadow-lg">
                <span class="material-symbols-rounded">add</span> æ–°å°è©±
            </button>
        </div>
        <div id="session-list" class="flex-1 overflow-y-auto px-3 space-y-1 pb-4"></div>
        <div class="p-4 border-t border-[#333] text-xs text-gray-500 text-center font-mono">v72.1 Mobile Edition</div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#131314] overflow-hidden w-full">
        <header class="h-14 flex items-center justify-between px-4 md:hidden border-b border-[#333] bg-[#1e1f22] shrink-0 z-20">
            <button onclick="toggleSidebar()" class="p-2 text-gray-400"><span class="material-symbols-rounded">menu</span></button>
            <span class="font-semibold text-sm truncate px-4" id="mobile-title">æ–°å°è©±</span>
            <div class="w-10"></div>
        </header>

        <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šåŠ å¤§äº† pb-48ï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆæ»‘å‹•åˆ°åº•éƒ¨æ™‚ï¼Œå°è©±å…§å®¹ä¸æœƒè¢«é«˜å¤§çš„è¼¸å…¥æ¡†é®æ“‹ -->
        <div id="chat-container" class="flex-1 overflow-y-auto overflow-x-hidden px-4 py-6 md:px-12 space-y-6 pb-48 md:pb-40 w-full relative">
            <div class="max-w-3xl mx-auto flex gap-4 sm:gap-6 w-full">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center shadow-lg shrink-0"><span class="material-symbols-rounded text-white">smart_toy</span></div>
                <div class="flex-1">
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-2">æˆ‘æ˜¯æ‚¨çš„ anyGem ä»£ç†äºº</h2>
                    <p class="text-gray-400 text-sm sm:text-base leading-relaxed">æˆ‘å·²æº–å‚™å¥½å”åŠ©æ‚¨è™•ç†é–‹ç™¼ã€ç°¡å ±èˆ‡æ–‡ä»¶ã€‚æ‚¨å¯ä»¥è©¦è‘—è®“æˆ‘å¯«ä¸€æ®µ React ä»£ç¢¼æˆ–ä¿®æ”¹æ‚¨çš„åœ–ç‰‡ã€‚</p>
                </div>
            </div>
        </div>

        <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šé‡æ–°èª¿æ•´åº•éƒ¨çš„ z-index èˆ‡ Padding é©é…æ‰‹æ©Ÿç‰ˆ -->
        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-[#131314] via-[#131314] to-transparent pt-12 pb-4 sm:pb-8 px-2 sm:px-4 md:px-12 z-20 pointer-events-none">
            <div class="max-w-3xl mx-auto w-full pointer-events-auto">
                <div id="upload-preview-container" class="hidden flex gap-3 mb-3 px-2">
                    <div class="relative group">
                        <img id="image-preview" class="hidden h-16 w-16 sm:h-20 sm:w-20 object-cover rounded-xl border-2 border-blue-500/50 shadow-lg">
                        <div id="doc-preview" class="hidden flex items-center gap-2 sm:gap-3 bg-[#2a2b2f] p-3 sm:p-4 rounded-xl border border-[#444] shadow-lg">
                            <span class="material-symbols-rounded text-blue-400 text-xl sm:text-2xl">description</span>
                            <span id="doc-filename" class="text-xs sm:text-sm font-medium truncate max-w-[120px] sm:max-w-[150px]"></span>
                        </div>
                        <button onclick="clearUpload()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md"><span class="material-symbols-rounded text-[14px] block">close</span></button>
                    </div>
                </div>

                <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šç¸®æ¸›æ‰‹æ©Ÿç‰ˆçš„å…§é‚Šè·ï¼Œæ¦¨å‡ºæ›´å¤šæ‰“å­—ç©ºé–“ -->
                <div class="bg-[#1e1f22] rounded-2xl border border-[#333] shadow-[0_-10px_40px_rgba(0,0,0,0.5)] focus-within:border-blue-500 transition-all p-1.5 sm:p-2 mx-1 sm:mx-0">
                    <div class="flex items-center gap-2 px-2 sm:px-3 mb-1 sm:mb-2 pt-1 border-b border-[#333] pb-1.5 sm:pb-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="web-search-toggle" class="sr-only peer">
                            <div class="w-8 h-4 bg-gray-600 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-full"></div>
                            <span class="ml-2 text-xs font-medium text-gray-400 peer-checked:text-blue-400 flex items-center gap-1">
                                <span class="material-symbols-rounded text-[14px] sm:text-sm">language</span> é€£ç¶²æœå°‹
                            </span>
                        </label>
                    </div>
                    
                    <div class="flex items-end gap-1 sm:gap-2 mt-1">
                        <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šåŠ å…¥ shrink-0 ç¢ºä¿æŒ‰éˆ•ä¸æœƒè¢«å£“æ‰ -->
                        <button onclick="document.getElementById('file-upload').click()" class="p-2 sm:p-3 shrink-0 text-gray-400 hover:text-white rounded-xl transition-colors"><span class="material-symbols-rounded block">attach_file</span></button>
                        <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(event)" accept="image/*,application/pdf,text/*">
                        
                        <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šç¢ºä¿å­—é«”ç‚º text-base (16px)ï¼Œé€™æ˜¯é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§çš„çµ‚æ¥µä¿è­‰ -->
                        <textarea id="user-input" rows="1" placeholder="è¼¸å…¥æŒ‡ä»¤æˆ–è²¼ä¸Šæˆªåœ–..." class="w-full bg-transparent border-none outline-none text-gray-100 py-2.5 sm:py-3 px-1 sm:px-2 resize-none max-h-32 sm:max-h-60 text-base leading-relaxed"></textarea>
                        
                        <!-- âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šåŠ å…¥ shrink-0 -->
                        <button id="send-btn" class="p-2.5 sm:p-3 shrink-0 bg-white text-black rounded-xl hover:bg-gray-200 transition-all shadow-md flex items-center justify-center">
                            <span class="material-symbols-rounded block">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é»æ“Šé®ç½©ï¼Œç”¨æ–¼æ‰‹æ©Ÿç‰ˆæ”¶åˆå´é‚Šæ¬„ -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden" onclick="toggleSidebar()"></div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec";

        marked.use({
            renderer: {
                link(href, title, text) {
                    const titleAttr = title ? `title="${title}"` : '';
                    return `<a href="${href}" ${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
                }
            }
        });

        let currentSessionId = generateUUID();
        let currentImageData = null, currentMimeType = null, currentDocumentText = null, currentDocumentName = null;
        let isWaiting = false, currentRenderCode = "";
        let abortController = null; 

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnIcon = sendBtn.querySelector('.material-symbols-rounded');

        function toggleSendButton(waiting) {
            isWaiting = waiting;
            if (waiting) {
                sendBtnIcon.innerText = 'stop';
                sendBtn.classList.remove('bg-white', 'text-black', 'hover:bg-gray-200');
                sendBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                sendBtn.onclick = stopGeneration;
            } else {
                sendBtnIcon.innerText = 'send';
                sendBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                sendBtn.classList.add('bg-white', 'text-black', 'hover:bg-gray-200');
                sendBtn.onclick = sendMessage;
            }
        }
        
        sendBtn.onclick = sendMessage;

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight > 240 ? 240 : this.scrollHeight) + 'px';
        });

        userInput.addEventListener('paste', function(e) {
            if (e.clipboardData && e.clipboardData.items) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault(); 
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            currentImageData = event.target.result;
                            currentMimeType = file.type;
                            document.getElementById('image-preview').src = currentImageData;
                            document.getElementById('image-preview').classList.remove('hidden');
                            document.getElementById('doc-preview').classList.add('hidden');
                            document.getElementById('upload-preview-container').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        return; 
                    }
                }
            }

            const pasteText = (e.clipboardData || window.clipboardData).getData('text');
            if (pasteText && pasteText.startsWith('data:image/')) {
                e.preventDefault(); 
                currentImageData = pasteText;
                const mimeMatch = pasteText.match(/data:(.*?);/);
                currentMimeType = mimeMatch ? mimeMatch[1] : 'image/png';
                
                document.getElementById('image-preview').src = currentImageData;
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('doc-preview').classList.add('hidden');
                document.getElementById('upload-preview-container').classList.remove('hidden');
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (window.innerWidth < 768) return;
                e.preventDefault();
                if (isWaiting) stopGeneration(); 
                else sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentImageData && !currentDocumentText) return;
            if (isWaiting) return;

            const isWebSearchEnabled = document.getElementById('web-search-toggle').checked;
            appendMessage('user', currentDocumentName ? `ğŸ“ [æ–‡ä»¶: ${currentDocumentName}]\n${text}` : text, currentImageData);
            
            let payloadText = text || "è«‹åˆ†ææ­¤å…§å®¹";
            if (currentDocumentText) payloadText = `ã€æª”æ¡ˆï¼š${currentDocumentName}ã€‘\n${currentDocumentText}\n\næŒ‡ä»¤ï¼š${payloadText}`;

            userInput.value = ''; userInput.style.height = 'auto';
            const imgBase64 = currentImageData ? currentImageData.split(',')[1] : null;
            const mime = currentMimeType;
            clearUpload();

            toggleSendButton(true); 
            const loadingId = appendLoading();
            
            abortController = new AbortController(); 

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        message: payloadText, session_id: currentSessionId, 
                        file_data: imgBase64, mime_type: mime,
                        web_search: isWebSearchEnabled 
                    }),
                    signal: abortController.signal
                });
                const data = await response.json();
                removeLoading(loadingId);
                if (data.status === "error") throw new Error(data.error);
                appendMessage('ai', data.reply, data.image ? `data:${data.mime};base64,${data.image}` : null, data.model);
                loadSessions(); 
            } catch (err) {
                removeLoading(loadingId);
                if (err.name === 'AbortError') {
                    appendMessage('ai', `ğŸ›‘ **ç”Ÿæˆå·²æ‰‹å‹•ä¸­æ­¢ã€‚**\næ‚¨å¯ä»¥éš¨æ™‚è¼¸å…¥æ–°çš„æŒ‡ä»¤ã€‚`);
                } else {
                    appendMessage('ai', `âŒ åŸ·è¡Œå¤±æ•—ï¼š\n\`\`\`text\n${err.message}\n\`\`\``);
                }
            } finally { 
                toggleSendButton(false); 
                abortController = null;
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => {
                    currentImageData = e.target.result; currentMimeType = file.type;
                    document.getElementById('image-preview').src = currentImageData;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('doc-preview').classList.add('hidden');
                    document.getElementById('upload-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                reader.onload = async (e) => {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise;
                    let text = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(s => s.str).join(' ') + "\n";
                    }
                    setDocPayload(file.name, text);
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => setDocPayload(file.name, e.target.result);
                reader.readAsText(file);
            }
        }

        function setDocPayload(name, text) {
            currentDocumentName = name; currentDocumentText = text;
            document.getElementById('doc-filename').innerText = name;
            document.getElementById('doc-preview').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('upload-preview-container').classList.remove('hidden');
        }

        function clearUpload() {
            currentImageData = null; currentDocumentText = null; currentDocumentName = null;
            document.getElementById('upload-preview-container').classList.add('hidden');
            document.getElementById('file-upload').value = '';
        }

        function appendMessage(role, text, imageSrc = null, model = null) {
            const isAI = role === 'ai';
            const wrap = document.createElement('div');
            wrap.className = `flex gap-3 sm:gap-4 max-w-4xl mx-auto w-full group ${!isAI ? 'flex-row-reverse' : ''}`;
            
            const avatar = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center shrink-0 shadow-lg ${isAI ? 'bg-blue-600' : 'bg-gray-700'}">
                <span class="material-symbols-rounded text-white text-[18px] sm:text-xl">${isAI ? 'smart_toy' : 'person'}</span>
            </div>`;

            let body = `<div class="flex-1 ${!isAI ? 'text-right' : ''} space-y-2 max-w-[90%] sm:max-w-[85%] relative min-w-0">`;
            if (imageSrc) body += `<img src="${imageSrc}" class="rounded-xl border border-[#333] mb-2 max-w-full">`;
            if (text) body += `<div class="prose prose-invert text-gray-200 bg-[#1e1f22] p-4 sm:p-5 rounded-2xl rounded-tl-none shadow-sm text-sm sm:text-base">${isAI ? marked.parse(text) : text.replace(/\n/g, '<br>')}</div>`;
            
            if (isAI && text) {
                body += `<div class="flex items-center gap-2 mt-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                    <button class="copy-btn p-1.5 text-gray-400 hover:text-white hover:bg-[#333] rounded-md"><span class="material-symbols-rounded text-[16px] sm:text-[18px]">content_copy</span></button>
                </div>`;
            }
            body += `</div>`;
            wrap.innerHTML = avatar + body;
            chatContainer.appendChild(wrap);

            if (isAI) {
                wrap.querySelectorAll('pre code').forEach(code => {
                    const lang = code.className;
                    if (lang.includes('language-html') || lang.includes('language-jsx') || lang.includes('language-javascript')) {
                        const btn = document.createElement('button');
                        btn.className = "absolute top-2 sm:top-3 right-2 sm:right-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] sm:text-xs px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg flex items-center gap-1 shadow-lg";
                        btn.innerHTML = '<span class="material-symbols-rounded text-[12px] sm:text-sm">play_circle</span> é è¦½';
                        btn.onclick = () => openPreview(code.innerText);
                        code.parentElement.appendChild(btn);
                    }
                });
            }

            if (isAI && text) {
                const btn = wrap.querySelector('.copy-btn');
                btn.onclick = () => {
                    navigator.clipboard.writeText(text).then(() => {
                        const icon = btn.querySelector('.material-symbols-rounded');
                        icon.innerText = 'check'; icon.classList.add('text-green-400');
                        setTimeout(() => { icon.innerText = 'content_copy'; icon.classList.remove('text-green-400'); }, 2000);
                    });
                };
            }
            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = "flex gap-3 sm:gap-4 max-w-4xl mx-auto w-full";
            div.innerHTML = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-600 flex items-center justify-center shrink-0 animate-pulse"><span class="material-symbols-rounded text-white text-[18px] sm:text-xl">hourglass_empty</span></div>
                <div class="pt-1.5 sm:pt-3 flex gap-2 items-center text-gray-500 text-xs sm:text-sm italic typing-indicator">ä»£ç†äººæ­£å¿™ç¢Œä¸­<span></span><span></span><span></span></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
        function generateUUID() { return 'xxxx-4xxx-yxxx'.replace(/[xy]/g, c => (c === 'x' ? (Math.random() * 16 | 0) : (Math.random() * 16 | 0 & 0x3 | 0x8)).toString(16)); }
        
        function toggleSidebar() { 
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full'); 
            overlay.classList.toggle('hidden');
        }
        
        function startNewSession() {
            currentSessionId = generateUUID(); chatContainer.innerHTML = '';
            appendMessage('ai', "æ‚¨å¥½ï¼å·²ç‚ºæ‚¨é–‹å•Ÿæ–°çš„å°è©±ã€‚æ‚¨å¯ä»¥è©¦è‘—è®“æˆ‘å¯«ä»£ç¢¼ã€è£½ä½œç°¡å ±æˆ–åˆ†ææ–‡ä»¶ã€‚");
            if (window.innerWidth < 768) toggleSidebar();
            loadSessions();
        }

        async function switchSession(id, title) {
            if (id === currentSessionId && chatContainer.children.length > 1) return;
            currentSessionId = id; document.getElementById('mobile-title').innerText = title;
            chatContainer.innerHTML = ''; const loadingId = appendLoading();
            if (window.innerWidth < 768) toggleSidebar();
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'load_session', session_id: id }) });
                const data = await res.json(); removeLoading(loadingId);
                data.logs.forEach(l => appendMessage(l.role === 'ai' ? 'ai' : 'user', l.text));
                loadSessions();
            } catch (e) { console.error(e); }
        }

        async function loadSessions() {
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'get_session_list' }) });
                const data = await res.json();
                const list = document.getElementById('session-list');
                list.innerHTML = '';
                data.sessions.forEach(s => {
                    const isActive = s.id === currentSessionId;
                    const isPinned = s.pinned;
                    const item = document.createElement('div');
                    item.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isActive ? 'active-session' : 'text-gray-400 hover:bg-[#2a2b2f] hover:text-white'}`;
                    const iconName = isPinned ? 'push_pin' : (isActive ? 'chat_bubble' : 'chat');
                    item.innerHTML = `<div class="flex items-center gap-3 truncate flex-1 min-w-0">
                        <span class="material-symbols-rounded text-lg shrink-0 ${isPinned ? 'pinned-icon' : ''}">${iconName}</span>
                        <span class="truncate text-sm">${s.title}</span>
                    </div>
                    <div class="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 shrink-0 ml-2">
                        <button class="p-1 pin-btn ${isPinned ? 'text-blue-500' : ''}"><span class="material-symbols-rounded text-sm">push_pin</span></button>
                        <button class="p-1 edit-btn"><span class="material-symbols-rounded text-sm">edit</span></button>
                        <button class="p-1 del-btn hover:text-red-400"><span class="material-symbols-rounded text-sm">delete</span></button>
                    </div>`;
                    item.onclick = () => switchSession(s.id, s.title);
                    item.querySelector('.pin-btn').onclick = (e) => { e.stopPropagation(); togglePinSession(s.id, isPinned); };
                    item.querySelector('.edit-btn').onclick = (e) => { e.stopPropagation(); renameSession(s.id, s.title); };
                    item.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); deleteSession(s.id); };
                    list.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }

        async function togglePinSession(id, current) {
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'pin_session', session_id: id, is_pinned: !current }) });
            loadSessions();
        }
        async function renameSession(id, old) {
            const n = prompt("é‡å‘½åå°è©±ï¼š", old);
            if (n && n.trim()) {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'rename_session', session_id: id, new_title: n }) });
                loadSessions();
            }
        }
        async function deleteSession(id) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'delete_session', session_id: id }) });
                if (id === currentSessionId) startNewSession(); else loadSessions();
            }
        }

        function openPreview(code) {
            let renderCode = code;
            const isReact = code.includes('export default') || code.includes('import React') || code.includes('className=');
            const isHTML = code.trim().toLowerCase().startsWith('<!doctype html') || code.trim().toLowerCase().startsWith('<html');

            if (isReact && !isHTML) {
                let cleanedCode = code.replace(/import\s+.*?from\s+['"].*?['"];?/g, '');
                let componentMatch = cleanedCode.match(/export\s+default\s+function\s+([A-Za-z0-9_]+)/);
                let renderTarget = componentMatch ? componentMatch[1] : 'App';
                cleanedCode = cleanedCode.replace(/export\s+default\s+function/g, 'function');

                renderCode = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/lucide@latest"><\/script>
</head>
<body class="bg-gray-50"><div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        try {
            ${cleanedCode}
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<${renderTarget} />);
            setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 100);
        } catch(err) {
            document.getElementById('root').innerHTML = '<div class="p-4 text-red-700"><strong>æ¸²æŸ“éŒ¯èª¤:</strong><br>' + err.message + '</div>';
        }
    <\/script>
</body></html>`;
            }
            currentRenderCode = renderCode;
            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('preview-modal').classList.add('flex');
            document.getElementById('preview-iframe').srcdoc = renderCode;
        }

        function closePreview() {
            document.getElementById('preview-modal').classList.add('hidden');
            document.getElementById('preview-modal').classList.remove('flex');
            document.getElementById('preview-iframe').srcdoc = '';
        }

        function refreshPreview() {
            if (currentRenderCode) document.getElementById('preview-iframe').srcdoc = currentRenderCode;
        }

        window.onload = loadSessions;
    </script>
</body>
</html>


