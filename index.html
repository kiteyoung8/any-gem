<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem v60.4 Agentic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #334155; }
        .markdown-body pre { background: #1e293b; padding: 12px; border-radius: 6px; overflow-x: auto; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const API_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; // ‚ö†Ô∏è ÂãôÂøÖÊõøÊèõÔºÅ

    const App = () => {
        const [mode, setMode] = useState('chat');
        const [input, setInput] = useState('');
        const [msgs, setMsgs] = useState([{id:0, role:'ai', text:'üëã <b>anyGem v60.4</b> Ready. Select a mode to start.'}]);
        const [loading, setLoading] = useState(false);
        const [file, setFile] = useState(null);
        const [sessId, setSessId] = useState(localStorage.getItem('AG_UID') || "UID_"+Date.now());
        const [pptOpts, setPptOpts] = useState({ length:6, ppt_mode:'hybrid', theme:'modern_blue', density:'detailed' });
        const [showPanel, setShowPanel] = useState(true);
        const [sessions, setSessions] = useState([]);
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const endRef = useRef(null);

        useEffect(() => { localStorage.setItem('AG_UID', sessId); fetchHistory(); }, [sessId]);
        useEffect(() => endRef.current?.scrollIntoView({behavior:'smooth'}), [msgs]);

        const fetchHistory = async () => { try { const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({mode:'system', action:'get_session_list'})}); const d = await r.json(); if(d.sessions) setSessions(d.sessions); } catch(e){} };
        const loadSession = async (id) => { setSessId(id); setLoading(true); const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({mode:'system', action:'load_session', session_id:id})}); const d = await r.json(); if(d.logs) setMsgs(d.logs.map((l,i)=>({id:i, ...l}))); setLoading(false); };
        const newChat = () => { setSessId("UID_"+Date.now()); setMsgs([]); setMode('chat'); };

        const send = async () => {
            if(!input && !file) return;
            const userMsg = { id:Date.now(), role:'user', text:input, meta:{fileName:file?.name} };
            setMsgs(p => [...p, userMsg]); setInput(''); setLoading(true);
            let fd = null; if(file) { fd = await new Promise(r=>{const fr=new FileReader(); fr.onload=e=>r(e.target.result.split(',')[1]); fr.readAsDataURL(file);}); }
            
            try {
                const res = await fetch(API_URL, {
                    method:'POST', body:JSON.stringify({
                        message: userMsg.text, session_id: sessId, mode: mode, file_data: fd, mime_type: file?.type,
                        options: mode==='presentation' ? pptOpts : { style:'Professional' }
                    })
                });
                const data = await res.json();
                setMsgs(p => [...p, { id:Date.now()+1, role:'ai', text: data.reply || "Error", meta:{ image: data.image, mime: data.mime } }]);
                fetchHistory();
            } catch(e) { setMsgs(p => [...p, { id:Date.now(), role:'system', text:"Connection Failed" }]); }
            setLoading(false); setFile(null);
        };

        return (
            <div className="flex h-screen bg-slate-950 text-slate-200">
                <aside className={`fixed md:relative z-20 w-64 h-full bg-[#0f172a] border-r border-slate-800 transition-transform ${sidebarOpen?'translate-x-0':'-translate-x-full md:translate-x-0'} flex flex-col`}>
                    <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                        <span className="font-bold text-emerald-500">anyGem v60.4</span>
                        <button onClick={newChat} className="bg-emerald-600 text-white px-3 py-1 rounded text-xs hover:bg-emerald-500">+ New</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2">
                        {sessions.map(s => <div key={s.id} onClick={()=>loadSession(s.id)} className={`p-2 mb-1 rounded cursor-pointer text-xs truncate ${s.id===sessId?'bg-slate-800 text-white':'text-slate-400 hover:bg-slate-900'}`}>{s.title||"Untitled"}</div>)}
                    </div>
                </aside>
                <div className="flex-1 flex flex-col relative">
                    <header className="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/50 backdrop-blur">
                        <div className="flex items-center gap-2">
                            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="md:hidden text-slate-400"><i className="fas fa-bars"></i></button>
                            {['chat','search','report','presentation','drawing'].map(m => <button key={m} onClick={()=>setMode(m)} className={`px-3 py-1 rounded capitalize text-sm transition ${mode===m?'bg-emerald-600 text-white':'text-slate-400 hover:text-white'}`}>{m}</button>)}
                        </div>
                        <button onClick={()=>setShowPanel(!showPanel)} className="hidden lg:block text-slate-400 hover:text-white"><i className="fas fa-cog"></i></button>
                    </header>
                    <div className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col">
                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {msgs.map(m => (
                                    <div key={m.id} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                        <div className={`max-w-[85%] p-4 rounded-xl text-sm ${m.role==='user'?'bg-emerald-700':'bg-slate-800 border border-slate-700'}`}>
                                            {m.meta?.fileName && <div className="text-xs opacity-50 mb-2">üìé {m.meta.fileName}</div>}
                                            {m.meta?.image && <img src={`data:${m.meta.mime};base64,${m.meta.image}`} />}
                                            <div className="markdown-body" dangerouslySetInnerHTML={{__html:marked.parse(m.text||"")}} />
                                        </div>
                                    </div>
                                ))}
                                {loading && <div className="text-center text-xs text-slate-500 animate-pulse">AI is thinking...</div>}
                                <div ref={endRef} />
                            </div>
                            <div className="p-4 bg-slate-900/80 border-t border-slate-800">
                                {file && <div className="text-xs text-emerald-400 mb-2">üìé {file.name} <button onClick={()=>setFile(null)}>‚úï</button></div>}
                                <div className="flex gap-2">
                                    <button onClick={()=>document.getElementById('f').click()} className="p-2 text-slate-400 hover:text-white"><i className="fas fa-paperclip"></i></button>
                                    <input type="file" id="f" className="hidden" onChange={e=>setFile(e.target.files[0])} />
                                    <textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}} className="flex-1 bg-slate-800 rounded p-2 text-sm outline-none resize-none" rows="1" placeholder="Type a message..." />
                                    <button onClick={send} disabled={loading} className="bg-emerald-600 text-white px-4 rounded hover:bg-emerald-500"><i className="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                        {showPanel && mode === 'presentation' && (
                            <div className="w-72 bg-slate-900 border-l border-slate-800 p-4 hidden lg:block">
                                <h3 className="text-sm font-bold text-white mb-4">Presentation Settings</h3>
                                <div className="space-y-4 text-xs">
                                    <div><label className="block text-slate-400 mb-1">Mode</label><select value={pptOpts.ppt_mode} onChange={e=>setPptOpts({...pptOpts, ppt_mode:e.target.value})} className="w-full bg-slate-800 p-2 rounded text-white"><option value="hybrid">‚ú® Hybrid (Smart)</option><option value="geometric">üìê Geometric (Fast)</option><option value="ai_visual">üé® Visual (Creative)</option></select></div>
                                    <div><label className="block text-slate-400 mb-1">Theme</label><select value={pptOpts.theme} onChange={e=>setPptOpts({...pptOpts, theme:e.target.value})} className="w-full bg-slate-800 p-2 rounded text-white"><option value="modern_blue">Modern Blue</option><option value="warm_orange">Warm Orange</option><option value="forest_green">Forest Green</option><option value="dark_cyber">Dark Cyber</option></select></div>
                                    <div><label className="block text-slate-400 mb-1">Slides: {pptOpts.length}</label><input type="range" min="3" max="20" value={pptOpts.length} onChange={e=>setPptOpts({...pptOpts, length:parseInt(e.target.value)})} className="w-full" /></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };
    const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
</script>
</body>
</html>
