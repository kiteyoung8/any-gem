<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .loading-dots::after { content: '.'; animation: dots 1.5s infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
        .prose pre { background: #1a1b26 !important; padding: 1rem; border-radius: 0.75rem; margin: 1rem 0; border: 1px solid #414868; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-300 h-screen flex flex-col font-sans">

    <header class="p-4 border-b border-slate-800 bg-[#1e293b]/50 backdrop-blur-md sticky top-0 z-10 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-cyan-500 rounded-full shadow-[0_0_10px_#22d3ee]"></div>
            <span class="text-xl font-bold tracking-tighter text-white">anyGem <span class="text-cyan-400">Core</span></span>
        </div>
        <div id="session-tag" class="text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-700 uppercase tracking-widest text-slate-500">ID: Initializing</div>
    </header>

    <main id="chat-window" class="flex-grow p-4 md:p-8 overflow-y-auto space-y-6 max-w-4xl mx-auto w-full"></main>

    <footer class="p-4 bg-[#1e293b] border-t border-slate-800">
        <div class="max-w-4xl mx-auto flex gap-3 relative">
            <input type="text" id="user-input" 
                   class="w-full bg-[#0f172a] border border-slate-700 rounded-2xl px-5 py-4 focus:outline-none focus:border-cyan-500 transition-all text-white shadow-inner" 
                   placeholder="è¼¸å…¥æŒ‡ä»¤æˆ–è©¢å•æŠ€è¡“å•é¡Œ...">
            <button onclick="handleSend()" id="send-btn" 
                    class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50">
                SEND
            </button>
        </div>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const input = document.getElementById('user-input');
        const btn = document.getElementById('send-btn');
        const sessId = "SESS-" + Math.random().toString(36).substr(2, 9);
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzaQVmwMalKAfw0zUtBkdpdnHpuOOmIkKJHkKKms2cNTEIRDjJTsu0zpKzvUuiymj9u/exec"; // ğŸ‘ˆ é‡è¦ï¼šè«‹æ›¿æ›ç‚ºä½ çš„ Web App URL

        document.getElementById('session-tag').innerText = `ID: ${sessId}`;

        async function handleSend() {
            const text = input.value.trim();
            if (!text || btn.disabled) return;

            addMessage('user', text);
            input.value = '';
            setLoading(true);

            try {
                const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ message: text, session_id: sessId }) });
                const data = await response.json();
                if (data.status === "success") {
                    addMessage('ai', data.reply);
                } else {
                    addMessage('ai', "âš ï¸ **Backend Error:** " + data.error);
                }
            } catch (e) {
                addMessage('ai', "âŒ **Connection Failed:** è«‹ç¢ºä¿ GAS éƒ¨ç½²æ¬Šé™ç‚ºã€ä»»ä½•äººã€ä¸”ç¶²å€æ­£ç¢ºã€‚");
            } finally {
                setLoading(false);
            }
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            
            const inner = document.createElement('div');
            inner.className = `max-w-[90%] md:max-w-[80%] p-4 rounded-2xl shadow-2xl prose prose-invert ${role === 'user' ? 'bg-cyan-900/50 border border-cyan-700 text-cyan-50' : 'bg-slate-800/80 border border-slate-700 text-slate-200'}`;
            
            // [å»ºè­° 3] è™•ç† Markdown èˆ‡ä»£ç¢¼
            inner.innerHTML = role === 'ai' ? marked.parse(content) : content;
            
            div.appendChild(inner);
            chatWindow.appendChild(div);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            if (role === 'ai') hljs.highlightAll();
        }

        function setLoading(status) {
            btn.disabled = status;
            if (status) {
                const loader = document.createElement('div');
                loader.id = 'loader';
                loader.className = 'flex justify-start';
                loader.innerHTML = '<div class="bg-slate-800/50 p-3 rounded-xl text-cyan-400 text-sm font-mono loading-dots">anyGem æ€è€ƒä¸­</div>';
                chatWindow.appendChild(loader);
            } else {
                const loader = document.getElementById('loader');
                if (loader) loader.remove();
            }
        }

        input.addEventListener('keydown', e => e.key === 'Enter' && handleSend());
    </script>
</body>
</html>