<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem v60.5 æ™ºèƒ½ä»£ç†äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #334155; }
        .markdown-body pre { background: #1e293b; padding: 12px; border-radius: 6px; overflow-x: auto; }
        .msg-text { letter-spacing: 0.02em; line-height: 1.7; }
        /* å´é‚Šæ¬„æ”¶åˆå‹•ç•« */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const API_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; // âš ï¸ è«‹å‹™å¿…ç¢ºèªæ­¤è™•å·²å¡«å…¥æ­£ç¢ºç¶²å€ï¼

    const App = () => {
        const [mode, setMode] = useState('chat');
        const [input, setInput] = useState('');
        const [msgs, setMsgs] = useState([{id:0, role:'ai', text:'ğŸ‘‹ <b>anyGem v60.5</b> æº–å‚™å°±ç·’ã€‚<br>å´é‚Šæ¬„ç¾åœ¨å¯ä»¥è‡ªç”±ç¸®æ”¾äº†ï¼'}]);
        const [loading, setLoading] = useState(false);
        const [file, setFile] = useState(null);
        const [sessId, setSessId] = useState(localStorage.getItem('AG_UID') || "UID_"+Date.now());
        const [pptOpts, setPptOpts] = useState({ length:6, ppt_mode:'hybrid', theme:'modern_blue', density:'detailed' });
        const [showPanel, setShowPanel] = useState(true);
        const [sessions, setSessions] = useState([]);
        
        // ç‹€æ…‹æ§åˆ¶ï¼šæ‰‹æ©Ÿç‰ˆé–‹å•Ÿ/é›»è…¦ç‰ˆæ”¶åˆ
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
        const [desktopCollapsed, setDesktopCollapsed] = useState(false);
        
        const endRef = useRef(null);

        const MODE_NAMES = { chat: 'ğŸ’¬ æ™ºèƒ½åŠ©ç†', search: 'ğŸŒ æ·±åº¦ç ”ç©¶', report: 'ğŸ“ å°ˆæ¥­ç ”å ±', presentation: 'ğŸ“Š æ™ºèƒ½ç°¡å ±', drawing: 'ğŸ¨ è—è¡“ç”Ÿåœ–' };

        useEffect(() => { localStorage.setItem('AG_UID', sessId); fetchHistory(); }, [sessId]);
        useEffect(() => endRef.current?.scrollIntoView({behavior:'smooth'}), [msgs]);

        const fetchHistory = async () => { try { const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({mode:'system', action:'get_session_list'})}); const d = await r.json(); if(d.sessions) setSessions(d.sessions); } catch(e){} };
        const loadSession = async (id) => { setSessId(id); setLoading(true); const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({mode:'system', action:'load_session', session_id:id})}); const d = await r.json(); if(d.logs) setMsgs(d.logs.map((l,i)=>({id:i, ...l}))); setLoading(false); if(window.innerWidth < 768) setMobileMenuOpen(false); };
        const newChat = () => { setSessId("UID_"+Date.now()); setMsgs([]); setMode('chat'); if(window.innerWidth < 768) setMobileMenuOpen(false); };

        const send = async () => {
            if(!input && !file) return;
            const userMsg = { id:Date.now(), role:'user', text:input, meta:{fileName:file?.name} };
            setMsgs(p => [...p, userMsg]); setInput(''); setLoading(true);
            let fd = null; if(file) { fd = await new Promise(r=>{const fr=new FileReader(); fr.onload=e=>r(e.target.result.split(',')[1]); fr.readAsDataURL(file);}); }
            try {
                const res = await fetch(API_URL, {
                    method:'POST', body:JSON.stringify({
                        message: userMsg.text, session_id: sessId, mode: mode, file_data: fd, mime_type: file?.type,
                        options: mode==='presentation' ? pptOpts : { style:'Professional' }
                    })
                });
                const data = await res.json();
                if(data.status === 'success') {
                    setMsgs(p => [...p, { id:Date.now()+1, role:'ai', text: data.reply || "å®Œæˆã€‚", meta:{ image: data.image, mime: data.mime } }]);
                    fetchHistory();
                } else { setMsgs(p => [...p, { id:Date.now(), role:'system', text:`ğŸš¨ éŒ¯èª¤: ${data.error}` }]); }
            } catch(e) { setMsgs(p => [...p, { id:Date.now(), role:'system', text:"âŒ é€£ç·šå¤±æ•—" }]); }
            setLoading(false); setFile(null);
        };

        const groupedSessions = useMemo(() => {
            const today = new Date().toDateString();
            const yesterday = new Date(new Date().setDate(new Date().getDate()-1)).toDateString();
            const groups = { 'ä»Šå¤©': [], 'æ˜¨å¤©': [], 'æ›´æ—©ä¹‹å‰': [] };
            sessions.forEach(s => {
                const d = new Date(s.timestamp).toDateString();
                if(d === today) groups['ä»Šå¤©'].push(s); else if(d === yesterday) groups['æ˜¨å¤©'].push(s); else groups['æ›´æ—©ä¹‹å‰'].push(s);
            });
            return groups;
        }, [sessions]);

        return (
            <div className="flex h-screen bg-slate-950 text-slate-200">
                {/* æ‰‹æ©Ÿç‰ˆé®ç½© */}
                {mobileMenuOpen && <div className="fixed inset-0 bg-black/60 z-30 md:hidden" onClick={()=>setMobileMenuOpen(false)}></div>}

                {/* å´é‚Šæ¬„ (æ”¯æ´æ”¶åˆ) */}
                <aside className={`
                    fixed md:relative z-40 h-full bg-[#0f172a] border-r border-slate-800 flex flex-col
                    sidebar-transition
                    ${mobileMenuOpen ? 'translate-x-0 w-64' : '-translate-x-full md:translate-x-0'}
                    ${desktopCollapsed ? 'md:w-16' : 'md:w-64'}
                `}>
                    <div className="p-4 border-b border-slate-800 flex justify-between items-center h-14">
                        {!desktopCollapsed && <span className="font-bold text-emerald-500 tracking-wider text-sm truncate">anyGem v60.5</span>}
                        
                        {/* æ”¶åˆæŒ‰éˆ• (é›»è…¦ç‰ˆ) */}
                        <button onClick={()=>setDesktopCollapsed(!desktopCollapsed)} className="hidden md:flex text-slate-400 hover:text-white p-1 rounded hover:bg-slate-800 transition-colors" title={desktopCollapsed ? "å±•é–‹" : "æ”¶åˆ"}>
                            <i className={`fas ${desktopCollapsed ? 'fa-angle-double-right' : 'fa-angle-double-left'}`}></i>
                        </button>
                        
                        {/* é—œé–‰æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆ) */}
                        <button onClick={()=>setMobileMenuOpen(false)} className="md:hidden text-slate-400"><i className="fas fa-times"></i></button>
                    </div>

                    <div className="p-2">
                        <button onClick={newChat} className={`flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-all shadow-lg ${desktopCollapsed ? 'justify-center p-2' : 'px-3 py-2 w-full'}`}>
                            <i className="fas fa-plus"></i>
                            {!desktopCollapsed && <span className="text-xs font-bold">æ–°å°è©±</span>}
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-2 custom-scrollbar overflow-x-hidden">
                        {desktopCollapsed ? (
                            // æ”¶åˆæ™‚åªé¡¯ç¤ºåœ–æ¨™
                            sessions.slice(0, 8).map(s => (
                                <div key={s.id} onClick={()=>loadSession(s.id)} className={`flex justify-center p-2 mb-2 rounded-lg cursor-pointer ${s.id===sessId?'bg-slate-800 text-emerald-400':'text-slate-500 hover:text-white'}`} title={s.title}>
                                    <i className="far fa-message"></i>
                                </div>
                            ))
                        ) : (
                            // å±•é–‹æ™‚é¡¯ç¤ºåˆ†çµ„æ¸…å–®
                            Object.entries(groupedSessions).map(([label, list]) => list.length > 0 && (
                                <div key={label} className="mb-4">
                                    <div className="text-[10px] text-slate-500 font-bold px-3 mb-2">{label}</div>
                                    {list.map(s => (
                                        <div key={s.id} onClick={()=>loadSession(s.id)} className={`group flex items-center px-3 py-2 mb-1 rounded-lg cursor-pointer text-xs transition-all ${s.id===sessId?'bg-slate-800 text-white border-l-2 border-emerald-500':'text-slate-400 hover:bg-slate-900 hover:text-slate-200'}`}>
                                            <i className="far fa-message mr-2 opacity-50"></i>
                                            <span className="truncate">{s.title||"æœªå‘½åå°è©±"}</span>
                                        </div>
                                    ))}
                                </div>
                            ))
                        )}
                    </div>
                </aside>

                {/* ä¸»ç•«é¢ */}
                <div className="flex-1 flex flex-col relative min-w-0">
                    <header className="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/50 backdrop-blur z-10">
                        <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={()=>setMobileMenuOpen(true)} className="md:hidden text-slate-400 p-2"><i className="fas fa-bars"></i></button>
                            {Object.entries(MODE_NAMES).map(([key, name]) => (
                                <button key={key} onClick={()=>setMode(key)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${mode===key?'bg-emerald-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                    <span className="hidden sm:inline">{name}</span>
                                    <span className="sm:hidden">{name.split(' ')[0]}</span>
                                </button>
                            ))}
                        </div>
                        <button onClick={()=>setShowPanel(!showPanel)} className="hidden lg:block text-slate-400 hover:text-emerald-400 p-2"><i className="fas fa-sliders-h"></i></button>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col bg-slate-950">
                            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 custom-scrollbar">
                                {msgs.map(m => (
                                    <div key={m.id} className={`flex ${m.role==='user'?'justify-end':'justify-start'} animate-fade-in`}>
                                        <div className={`max-w-[90%] md:max-w-[75%] p-4 rounded-2xl text-sm shadow-xl msg-text ${m.role==='user'?'bg-emerald-700 text-white rounded-tr-sm':'bg-slate-900 border border-slate-800 text-slate-300 rounded-tl-sm'}`}>
                                            {m.meta?.fileName && <div className="text-xs bg-black/20 p-2 rounded mb-3 flex items-center gap-2"><i className="fas fa-file"></i> {m.meta.fileName}</div>}
                                            {m.meta?.image && <img src={`data:${m.meta.mime};base64,${m.meta.image}`} className="shadow-lg mb-3" />}
                                            <div className="markdown-body" dangerouslySetInnerHTML={{__html:marked.parse(m.text||"")}} />
                                            {m.role === 'ai' && <div className="mt-3 pt-2 border-t border-white/5 flex justify-between items-center"><span className="text-[10px] opacity-50">{m.meta?.model || 'AI'}</span><button onClick={()=>navigator.clipboard.writeText(m.text)} className="text-[10px] hover:text-emerald-400 opacity-50 hover:opacity-100"><i className="fas fa-copy"></i></button></div>}
                                        </div>
                                    </div>
                                ))}
                                {loading && <div className="flex justify-start"><div className="bg-slate-900 p-3 rounded-2xl rounded-tl-sm text-xs text-emerald-500 animate-pulse flex items-center gap-2"><i className="fas fa-circle-notch fa-spin"></i> æ€è€ƒä¸­...</div></div>}
                                <div ref={endRef} />
                            </div>

                            <div className="p-4 bg-slate-900/90 border-t border-slate-800 backdrop-blur-md">
                                {file && <div className="text-xs text-emerald-400 mb-2 flex items-center gap-2 bg-emerald-900/20 p-2 rounded w-fit"><i className="fas fa-paperclip"></i> {file.name} <button onClick={()=>setFile(null)} className="hover:text-white ml-2">âœ•</button></div>}
                                <div className="flex gap-2 items-end max-w-4xl mx-auto bg-slate-800/50 p-2 rounded-xl border border-slate-700 focus-within:border-emerald-500/50 transition-colors">
                                    <button onClick={()=>document.getElementById('f').click()} className="p-3 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-700"><i className="fas fa-paperclip text-lg"></i></button>
                                    <input type="file" id="f" className="hidden" onChange={e=>setFile(e.target.files[0])} />
                                    <textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}} className="flex-1 bg-transparent text-slate-200 text-sm outline-none resize-none py-3 px-2 max-h-32 placeholder-slate-500" rows="1" placeholder={`è¼¸å…¥è¨Šæ¯...`} />
                                    <button onClick={send} disabled={loading||(!input&&!file)} className="bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-500 disabled:opacity-50 transition-all shadow-lg"><i className="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>

                        {showPanel && (mode === 'presentation' || mode === 'report') && (
                            <div className="w-80 bg-slate-900 border-l border-slate-800 p-6 hidden lg:flex flex-col animate-fade-in">
                                <div className="flex items-center gap-2 mb-6 text-emerald-500"><i className="fas fa-sliders-h"></i><h3 className="font-bold text-sm">{mode==='presentation'?'ç°¡å ±å¼•æ“':'ç ”å ±'}è¨­å®š</h3></div>
                                {mode === 'presentation' ? (
                                    <div className="space-y-6 flex-1 text-xs">
                                        <div className="space-y-2"><label className="block text-slate-400 font-bold uppercase">ç”Ÿæˆæ¨¡å¼</label><select value={pptOpts.ppt_mode} onChange={e=>setPptOpts({...pptOpts, ppt_mode:e.target.value})} className="w-full bg-slate-800 p-3 rounded-lg text-slate-200 border border-slate-700 focus:border-emerald-500 outline-none"><option value="hybrid">âœ¨ æ™ºèƒ½æ··åˆ</option><option value="geometric">ğŸ“ ç´”å¹¾ä½•</option><option value="ai_visual">ğŸ¨ ç´” AI è¦–è¦º</option></select></div>
                                        <div className="space-y-2"><label className="block text-slate-400 font-bold uppercase">é…è‰²ä¸»é¡Œ</label><div className="grid grid-cols-2 gap-2">{[{v:'modern_blue', l:'ğŸ”µ ç§‘æŠ€è—'},{v:'warm_orange', l:'ğŸŸ  æº«æš–æ©˜'},{v:'forest_green', l:'ğŸŸ¢ æ£®æ—ç¶ '},{v:'dark_cyber', l:'âš« æš—é»‘ç³»'}].map(t => (<button key={t.v} onClick={()=>setPptOpts({...pptOpts, theme:t.v})} className={`p-2 rounded border text-left transition-all ${pptOpts.theme===t.v?'bg-emerald-900/30 border-emerald-500 text-emerald-400':'bg-slate-800 border-slate-700 text-slate-400'}`}>{t.l}</button>))}</div></div>
                                        <div className="space-y-2"><label className="block text-slate-400 font-bold uppercase flex justify-between"><span>é æ•¸</span> <span className="text-emerald-400">{pptOpts.length}</span></label><input type="range" min="3" max="20" value={pptOpts.length} onChange={e=>setPptOpts({...pptOpts, length:parseInt(e.target.value)})} className="w-full accent-emerald-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" /></div>
                                    </div>
                                ) : (
                                    <div className="text-xs text-slate-400">ç³»çµ±å°‡è‡ªå‹•æ’°å¯«å ±å‘Šä¸¦ç”Ÿæˆ Google Docã€‚</div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };
    const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
</script>
</body>
</html>
