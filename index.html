<div id="file-preview-area" class="px-4 hidden animate-fade-in">
    <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-3 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div id="file-icon-preview" class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center text-xl"></div>
            <div class="flex flex-col">
                <span id="file-name-text" class="text-xs font-bold text-white truncate max-w-[200px]"></span>
                <span id="file-size-text" class="text-[10px] text-emerald-400"></span>
            </div>
        </div>
        <button onclick="clearFile()" class="text-slate-500 hover:text-white transition-colors">âœ•</button>
    </div>
</div>

<input type="file" id="file-upload" class="hidden" accept="image/*,.pdf,.doc,.docx,.ppt,.pptx">

<script>
    // ... åŸæœ‰è®Šæ•¸å®šç¾© ...
    const filePreviewArea = document.getElementById('file-preview-area');
    const fileNameText = document.getElementById('file-name-text');
    const fileIconPreview = document.getElementById('file-icon-preview');
    
    let activeFile = null;

    // è™•ç†æª”æ¡ˆé¸å–
    document.getElementById('file-upload').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        activeFile = file;
        filePreviewArea.classList.remove('hidden');
        fileNameText.innerText = file.name;
        
        // å‘ˆç¾ç¸®åœ–æˆ–åœ–ç¤º
        if(file.type.startsWith('image/')) {
            const url = URL.createObjectURL(file);
            fileIconPreview.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded">`;
        } else {
            // æ–‡ä»¶åœ–ç¤º
            const icon = file.type.includes('pdf') ? 'ğŸ“•' : (file.type.includes('presentation') ? 'ğŸ“™' : 'ğŸ“˜');
            fileIconPreview.innerHTML = icon;
        }
    };

    function clearFile() {
        activeFile = null;
        document.getElementById('file-upload').value = '';
        filePreviewArea.classList.add('hidden');
    }

    async function handleSend() {
        const text = input.value.trim();
        if(!text && !activeFile) return;

        const m = modeSelect.value;
        const currentFile = activeFile; // æš«å­˜ç›®å‰çš„æª”æ¡ˆä»¥ä¾¿å‚³é€

        // âœ¨ å‘ˆç¾ç¸®åœ–æˆ–æ–‡ä»¶åæ–¼ä½¿ç”¨è€…å°è©±æ¡†
        addMessage('user', text, { 
            fileName: currentFile ? currentFile.name : null,
            fileType: currentFile ? currentFile.type : null,
            isImage: currentFile ? currentFile.type.startsWith('image/') : false,
            fileObject: currentFile 
        });

        const payload = { 
            message: text, 
            session_id: sessId, 
            mode: m,
            options: {
                strategy: document.getElementById('ppt-strategy').value,
                style: document.getElementById('ppt-style').value
            }
        };

        input.value = '';
        
        if(currentFile) {
            setLoading(true, "Encoding File...");
            payload.file_data = (await toBase64(currentFile)).split(',')[1];
            payload.mime_type = currentFile.type;
            clearFile();
        }

        setLoading(true, "AI Processing...");
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            if(data.status === "success") {
                addMessage('ai', data.reply, { model: data.model, image: data.image, mime: data.mime });
            } else { addMessage('ai', "ğŸš¨ éŒ¯èª¤: " + data.error); }
        } catch (e) { addMessage('ai', "âŒ é€£ç·šå¤±æ•—"); } finally { setLoading(false); }
    }

    // ä¿®æ”¹å¾Œçš„è¨Šæ¯æ¸²æŸ“
    function addMessage(role, text, meta = null) {
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in mb-6 group`;
        const msgBox = document.createElement('div');
        msgBox.className = `max-w-[85%] p-4 rounded-2xl ${role === 'user' ? 'bg-emerald-700/80 text-white' : 'bg-[#1e293b] text-slate-200 border border-emerald-500/10'} shadow-xl relative prose prose-invert prose-sm`;
        
        // ä½¿ç”¨è€…é¸å–çš„æª”æ¡ˆå±•ç¤º
        if(role === 'user' && meta && meta.fileName) {
            const fileBadge = document.createElement('div');
            fileBadge.className = "mb-2 p-2 bg-black/20 rounded-lg border border-white/10 flex items-center space-x-2";
            if(meta.isImage && meta.fileObject) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(meta.fileObject);
                img.className = "w-12 h-12 object-cover rounded";
                fileBadge.appendChild(img);
            } else {
                const icon = document.createElement('span');
                icon.innerText = meta.fileType.includes('pdf') ? 'ğŸ“„' : 'ğŸ“';
                fileBadge.appendChild(icon);
            }
            const name = document.createElement('span');
            name.className = "text-[10px] font-mono truncate";
            name.innerText = meta.fileName;
            fileBadge.appendChild(name);
            msgBox.appendChild(fileBadge);
        }

        // AI ç”Ÿæˆçš„åœ–ç‰‡
        if(meta && meta.image) {
            const img = document.createElement('img');
            img.src = `data:${meta.mime || 'image/png'};base64,${meta.image}`;
            img.className = "w-full rounded-lg mb-3 shadow-lg";
            msgBox.appendChild(img);
        }

        if (text) {
            const tNode = document.createElement('div');
            tNode.innerHTML = marked.parse(text);
            msgBox.appendChild(tNode);
        }
        
        chatWindow.appendChild(wrapper); wrapper.appendChild(msgBox); chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function toBase64(f) { return new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }
</script>
